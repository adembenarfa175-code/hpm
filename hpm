#!/bin/bash
# HPM: Hybrid Package Manager - Command Line Interface (CLI)
# Version: 1.0 (Build System Integration)
# License: GPLv2

# =======================================================
# 1. Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª ÙˆØ§Ù„Ù…ØªØºÙŠØ±Ø§Øª
# =======================================================
HPM_PATH="$(dirname "$(readlink -f "$0")")"
REPO_BASE_URL="http://localhost:8080"

# Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø¤Ù‚ØªØ© (ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† ÙÙŠ /tmp Ù„Ø¶Ù…Ø§Ù† Ø§Ù„ØªÙ†Ø¸ÙŠÙ)
DOWNLOAD_DIR="/tmp/hpm_downloads"
BUILD_DIR="/tmp/hpm_build"

# Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
if [ ! -f "$HPM_PATH/hpm_driver" ]; then
    echo "ERROR: hpm_driver (C-Core) binary not found."
    echo "Please run 'make' first to compile hpm_file_driver.c."
    exit 1
fi

# =======================================================
# 2. Ø§Ù„Ø´Ø¹Ø§Ø± ÙˆÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø¹Ø±Ø¶
# =======================================================
function hpm_banner() {
    echo ""
    echo "â–ˆâ–€â–€â€ƒâ–ˆ â–ˆâ€ƒâ–ˆâ–€â–„â€ƒâ–ˆâ–€â–ˆ"
    echo "â–ˆâ–„â–„â€ƒâ–ˆâ–„â–ˆâ€ƒâ–ˆâ–„â–€â€ƒâ–ˆâ–€â–„"
    echo "------------------------------------"
    echo "HPM C-Core Workflow: Starting for: $1"
    echo "------------------------------------"
}

function hpm_usage() {
    echo "HPM: Hybrid Package Manager"
    echo "License: GPLv2"
    echo ""
    echo "Usage: ./hpm <command> [options]"
    echo ""
    echo "Commands:"
    echo "  install <PackageName>    Download, build, and install a package."
    echo "  buildsystem              Start the full HPM Linux distribution build process (requires sudo)."
    echo ""
}

# =======================================================
# 3. ÙˆØ¸ÙŠÙØ© Ø§Ù„ØªÙ†Ø¸ÙŠÙ (Cleanup)
# =======================================================
function hpm_cleanup() {
    local package_path="$1"
    local build_path="$2"
    local cleanup_status=0

    echo "[HPM Cleanup] Starting temporary files cleanup..."

    if [ -f "$package_path" ]; then
        rm -f "$package_path"
        echo "  [OK] Removed downloaded package: $package_path"
    fi

    if [ -d "$build_path" ]; then
        rm -rf "$build_path"
        echo "  [OK] Removed extraction directory: $build_path"
    fi
    
    return $cleanup_status
}

# =======================================================
# 4. ÙˆØ¸ÙŠÙØ© Ø§Ù„ØªØ«Ø¨ÙŠØª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
# =======================================================
function hpm_install() {
    local package_name="$1"
    
    if [ -z "$package_name" ]; then
        echo "Error: Package name is required."
        hpm_usage
        return 1
    fi

    hpm_banner "$package_name"
    
    local package_url="$REPO_BASE_URL/$package_name.hpm"
    local local_path="$DOWNLOAD_DIR/$package_name.hpm"
    local exit_status=0

    # 1. Ø§Ù„ØªÙ†Ø²ÙŠÙ„ Ø§Ù„ØµØ§Ù…Øª Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… wget -q
    echo "[hpm:1] Downloading $package_name from $package_url"
    mkdir -p "$DOWNLOAD_DIR"
    
    # ØªÙ†ÙÙŠØ° wget -q (Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµØ§Ù…Øª)
    wget -q "$package_url" -O "$local_path"
    exit_status=$?

    if [ $exit_status -eq 0 ]; then
        echo "[hpm:2] OK: Download successful to $local_path"
    else
        echo "[hpm:2] ERROR: Failed to download package (Wget Status: $exit_status)."
        hpm_cleanup "$local_path" "$BUILD_DIR"
        return 1
    fi

    # 2. ÙÙƒ Ø§Ù„Ø¶ØºØ· ÙˆØ§Ù„ØªØ¬Ù…ÙŠØ¹ ÙˆØ§Ù„ØªØ«Ø¨ÙŠØª Ø¨ÙˆØ§Ø³Ø·Ø© hpm_driver
    echo "[HPM Driver] Invoking C-based driver for build and install..."
    
    # Ù†Ù…Ø±Ø± Ù…Ø³Ø§Ø± Ø§Ù„Ø­Ø²Ù…Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ© ÙˆÙ…Ø³Ø§Ø± Ø§Ù„Ø¨Ù†Ø§Ø¡
    "$HPM_PATH/hpm_driver" "$local_path" "$BUILD_DIR"
    exit_status=$?

    if [ $exit_status -eq 0 ]; then
        echo "------------------------------------"
        echo "âœ… Package '$package_name' installed successfully."
        echo "------------------------------------"
    else
        echo "------------------------------------"
        echo "ğŸ›‘ Installation of '$package_name' FAILED (Driver Status: $exit_status)."
        echo "------------------------------------"
    fi

    # 3. Ø§Ù„ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ (ÙŠØ­Ø¯Ø« Ø³ÙˆØ§Ø¡ Ù†Ø¬Ø­ Ø§Ù„ØªØ«Ø¨ÙŠØª Ø£Ùˆ ÙØ´Ù„)
    hpm_cleanup "$local_path" "$BUILD_DIR"
    return $exit_status
}

# =======================================================
# 5. ÙˆØ¸ÙŠÙØ© Ø¨Ù†Ø§Ø¡ Ù†Ø¸Ø§Ù… HPM (Chroot Build System)
# =======================================================
function hpm_buildsystem() {
    echo "--- HPM Distribution Build System Setup ---"
    
    # ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø§Ù„Ø³ÙƒØ±ÙŠØ¨Øª build.sh Ø¬Ø§Ù‡Ø²Ø§Ù‹ ÙˆÙ‚Ø§Ø¨Ù„Ø§Ù‹ Ù„Ù„ØªÙ†ÙÙŠØ°
    if [ ! -f "$HPM_PATH/build-system/build.sh" ]; then
        echo "ERROR: Build system script is missing or not configured."
        echo "Please ensure $HPM_PATH/build-system/build.sh exists."
        return 1
    fi

    if [[ $EUID -ne 0 ]]; then
       echo "--------------------------------------------------------"
       echo "ğŸ›‘ ERROR: Build System requires root permissions for chroot."
       echo "   Please run this command with 'sudo'."
       echo "--------------------------------------------------------"
       return 1
    fi

    # ØªÙ†ÙÙŠØ° Ø³ÙƒØ±ÙŠØ¨Øª Ø§Ù„Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ (Ø§Ù„Ø°ÙŠ Ø³ÙŠÙ‚ÙˆÙ… Ø¨Ø§Ù„Ù€ chroot Ùˆ mount)
    echo "Starting full system build via build-system/build.sh..."
    bash "$HPM_PATH/build-system/build.sh"
    
    local build_status=$?
    
    if [ $build_status -eq 0 ]; then
        echo "âœ… HPM Distribution built successfully."
    else
        echo "ğŸ›‘ HPM Distribution build FAILED."
    fi
    
    return $build_status
}

# =======================================================
# 6. Ù…Ø¹Ø§Ù„Ø¬ Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© (CLI Entry Point)
# =======================================================
case "$1" in
    install)
        hpm_install "$2"
        ;;
    buildsystem)
        hpm_buildsystem
        ;;
    *)
        hpm_usage
        ;;
esac

